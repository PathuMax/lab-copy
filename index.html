<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Copy Lab Program</title>
  <style>
    html,body{height:100%;margin:0;background:#fff}
    #fallback{display:none;position:fixed;inset:0;align-items:center;justify-content:center;font-family:sans-serif}
    #fallback.show{display:flex}
  </style>
</head>
<body>
  <div id="fallback">
    <p>Auto-copy blocked. <button id="manual">Click to copy</button></p>
  </div>

<script>
async function fetchFile(path){
  try{
    const res = await fetch(path, {cache: "no-store"});
    if(!res.ok) throw new Error("Failed to fetch " + path);

    // Try text first, then fallback to base64 if binary
    const contentType = res.headers.get("content-type") || "";
    if (contentType.startsWith("text") || path.endsWith(".txt") || path.endsWith(".json") || path.endsWith(".html")) {
      return await res.text();
    } else {
      // Non-text file (.pkt, .zip, etc.)
      const blob = await res.blob();
      return await blobToBase64(blob); // Base64 encode binary
    }
  } catch (err) {
    console.error(err);
    return null;
  }
}

// Helper: convert Blob to Base64 string
function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}

async function copyText(t){
  if(!t) return false;
  if(navigator.clipboard?.writeText){
    try { await navigator.clipboard.writeText(t); return true; } catch{}
  }
  try{
    const ta = document.createElement('textarea');
    ta.value = t;
    ta.style.position='fixed';
    ta.style.left='-9999px';
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return !!ok;
  }catch(e){ return false; }
}

async function handleKeyPress(e){
  const key = e.key;
  let file = null;

  // Map keys to files (any extension allowed)
  if(key === '1') file = 'program.txt';
  else if(key === '4') file = 'sdn 4.pkt';
  else if(key === '3') file = 'sdn 3.pkt';
  else return; // ignore other keys

  const data = await fetchFile(file);
  if(!data){
    console.warn(`Could not fetch ${file}`);
    document.getElementById('fallback').classList.add('show');
    document.getElementById('manual').onclick = () => alert(`Could not load ${file} from server.`);
    return;
  }

  const ok = await copyText(data);
  if(ok){
    console.log(`${file} copied successfully ✅`);
  } else {
    console.warn(`Copy failed for ${file}`);
    document.getElementById('fallback').classList.add('show');
    document.getElementById('manual').onclick = async ()=>{
      const ok2 = await copyText(data);
      alert(ok2 ? `${file} copied ✅` : `Copy failed ❌`);
    };
  }
}

window.addEventListener('keydown', handleKeyPress);
</script>
</body>
</html>
